# Supabase 密碼重置流程

這份文檔詳細說明了我們應用程序中的密碼重置流程，以及它如何與 Supabase 身份驗證系統集成。

## 密碼重置流程概述

完整的密碼重置流程如下：

1. 用戶在登入頁面點擊"忘記密碼"按鈕
2. 用戶在確認模態框中提供電子郵件地址
3. 系統發送密碼重置鏈接到用戶的電子郵件
4. 用戶點擊電子郵件中的鏈接，被帶到密碼重置頁面
5. 用戶輸入新密碼並提交
6. 系統更新密碼並重定向用戶到登入頁面

## 技術實現

### 1. 開始密碼重置流程

在登入頁面，用戶點擊"忘記密碼"按鈕時，我們顯示一個確認模態框，要求用戶輸入電子郵件地址。當用戶確認後，我們調用 Supabase 的密碼重置 API：

```javascript
const { error } = await supabase.auth.resetPasswordForEmail(emailAddress, {
  redirectTo: `${window.location.origin}/reset-password`,
});
```

`redirectTo` 參數指定用戶點擊電子郵件中的鏈接後應該被重定向到的 URL。

### 2. Supabase 發送重置郵件

Supabase 會向用戶提供的電子郵件地址發送一封包含密碼重置鏈接的電子郵件。該鏈接包含以下參數：

- `type=recovery` - 表示這是密碼恢復流程
- `token=[JWT令牌]` - 包含加密的用戶信息的 JWT 令牌
- 其他可能的參數

### 3. 用戶點擊重置鏈接

當用戶點擊電子郵件中的鏈接時，他們會被帶到我們的 `/reset-password` 頁面，附帶上述參數。這些參數會自動被 Supabase 客戶端庫處理。

### 4. 處理密碼重置

在密碼重置頁面，我們檢查 URL 參數以確保是有效的重置請求：

```javascript
const type = searchParams.get('type')
const token = searchParams.get('token')

if (!type || type !== 'recovery' || !token) {
  // 顯示錯誤，無效的重置鏈接
}
```

如果參數有效，用戶可以輸入新密碼。當表單提交時，我們調用 Supabase 的更新用戶 API：

```javascript
const { error } = await supabase.auth.updateUser({
  password: newPassword
});
```

Supabase 會使用 URL 中的令牌來識別正在重置密碼的用戶，不需要我們手動處理令牌。

### 5. 重置成功

密碼重置成功後，我們顯示一個成功模態框，然後重定向用戶到登入頁面，讓他們可以使用新密碼登入。

## Supabase 配置

為了使密碼重置功能正常工作，我們需要在 Supabase 項目中進行一些配置：

### 自定義重置密碼電子郵件

1. 登錄到 Supabase 控制台
2. 導航到 Authentication > Email Templates
3. 選擇 "Reset Password" 模板
4. 自定義電子郵件主題和內容
5. 確保電子郵件內容中包含 `{{ .ConfirmationURL }}` 變數，這會被替換為實際的重置鏈接

### URL 配置

1. 導航到 Authentication > URL Configuration
2. 在 "Site URL" 欄位中輸入您的站點 URL（例如 https://your-app.com）
3. 在 "Redirect URLs" 中添加您的重置密碼頁面的 URL（例如 https://your-app.com/reset-password）

## 安全考慮

1. **令牌過期**：密碼重置令牌通常在 24 小時後過期，確保提醒用戶及時操作。

2. **速率限制**：Supabase 對密碼重置請求有速率限制，防止濫用。

3. **電子郵件驗證**：我們建議開啟電子郵件驗證功能，這樣只有驗證過的電子郵件地址才能進行密碼重置。

4. **密碼強度**：在客戶端和服務器端都進行密碼強度檢查，確保新密碼足夠強大。

## 最佳實踐

1. **提供清晰指引**：在整個流程中提供清晰的指引，告訴用戶下一步該做什麼。

2. **處理錯誤情況**：優雅地處理所有可能的錯誤情況，並向用戶提供有意義的錯誤消息。

3. **確認郵件發送**：通知用戶重置郵件已發送，並建議檢查垃圾郵件文件夾。

4. **限制重置頁面訪問**：只有通過有效的重置鏈接才能訪問密碼重置頁面。

5. **記錄安全事件**：記錄所有密碼重置嘗試，以幫助檢測潛在的濫用。

## 疑難排解

如果用戶報告無法重置密碼，可能的原因包括：

1. 重置令牌已過期 - 建議用戶重新請求密碼重置。
2. 電子郵件地址不存在 - 確認用戶使用了正確的電子郵件地址。
3. 電子郵件被標記為垃圾郵件 - 建議用戶檢查垃圾郵件文件夾。
4. 重置鏈接被破壞 - 確保電子郵件客戶端沒有破壞鏈接。

通過遵循這份文檔中的流程和最佳實踐，您可以為用戶提供一個安全且用戶友好的密碼重置體驗。
